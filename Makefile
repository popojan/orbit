.PHONY: preview clean generate-index

DOCS := $(shell find . -name '*.md' -not -path './preview/*')
HTML := $(patsubst %.md,preview/%.html,$(DOCS))

preview: generate-index $(HTML) copy-assets
	@echo "✓ All HTML previews generated in preview/"
	@xdg-open "file://$(shell pwd)/preview/docs/index.html" 2>/dev/null || open "file://$(shell pwd)/preview/docs/index.html" 2>/dev/null || echo "Please open preview/docs/index.html manually"

generate-index:
	@echo "Generating docs/README.md..."
	@echo "# Documentation Index" > docs/README.md
	@echo "" >> docs/README.md
	@echo "**Generated:** $$(date '+%Y-%m-%d %H:%M:%S')" >> docs/README.md
	@echo "" >> docs/README.md
	@echo "## Theorems (Master References)" >> docs/README.md
	@echo "" >> docs/README.md
	@for file in docs/theorems/*/README.md; do \
		if [ -f "$$file" ]; then \
			TITLE=$$(grep -m1 '^# ' "$$file" 2>/dev/null | sed 's/^# //' || echo "$$(basename $$(dirname $$file))"); \
			RELPATH=$$(echo "$$file" | sed 's|^docs/||'); \
			echo "- [$$TITLE]($$RELPATH)" >> docs/README.md; \
		fi; \
	done
	@echo "" >> docs/README.md
	@echo "## Complete Proofs" >> docs/README.md
	@echo "" >> docs/README.md
	@for file in docs/proofs/*.md; do \
		if [ -f "$$file" ]; then \
			TITLE=$$(grep -m1 '^# ' "$$file" 2>/dev/null | sed 's/^# //' || echo "$$(basename $$file .md)"); \
			RELPATH=$$(echo "$$file" | sed 's|^docs/||'); \
			echo "- [$$TITLE]($$RELPATH)" >> docs/README.md; \
		fi; \
	done
	@echo "" >> docs/README.md
	@echo "## Reference Documentation" >> docs/README.md
	@echo "" >> docs/README.md
	@for file in docs/reference/*.md; do \
		if [ -f "$$file" ]; then \
			TITLE=$$(grep -m1 '^# ' "$$file" 2>/dev/null | sed 's/^# //' || echo "$$(basename $$file .md)"); \
			RELPATH=$$(echo "$$file" | sed 's|^docs/||'); \
			echo "- [$$TITLE]($$RELPATH)" >> docs/README.md; \
		fi; \
	done
	@echo "" >> docs/README.md
	@echo "## Recent Sessions (Last 10)" >> docs/README.md
	@echo "" >> docs/README.md
	@for file in $$(find docs/sessions -name '*.md' -type f | while read f; do \
		if git ls-files --error-unmatch "$$f" >/dev/null 2>&1; then \
			COMMIT_TIME=$$(git log -1 --format=%ct "$$f" 2>/dev/null || echo 0); \
		else \
			COMMIT_TIME=$$(stat -c %Y "$$f" 2>/dev/null || stat -f %m "$$f" 2>/dev/null || echo 0); \
		fi; \
		echo "$$COMMIT_TIME $$f"; \
	done | sort -rn | head -10 | cut -d' ' -f2-); do \
		TITLE=$$(grep -m1 '^# ' "$$file" 2>/dev/null | sed 's/^# //' || echo "$$(basename $$file .md)"); \
		COMMIT_DATE=$$(git log -1 --format=%ci "$$file" 2>/dev/null | cut -d' ' -f1 || echo "unknown"); \
		RELPATH=$$(echo "$$file" | sed 's|^docs/||'); \
		echo "- [$$TITLE]($$RELPATH) *($$COMMIT_DATE)*" >> docs/README.md; \
	done
	@echo "" >> docs/README.md
	@echo "## Navigation" >> docs/README.md
	@echo "" >> docs/README.md
	@echo "- [STATUS.md](STATUS.md) - Master status tracker" >> docs/README.md
	@echo "- [reference/](reference/) - Mathematical foundations and design rationale" >> docs/README.md
	@echo "- [theorems/](theorems/) - All theorems organized by topic" >> docs/README.md
	@echo "- [proofs/](proofs/) - Complete standalone proofs" >> docs/README.md
	@echo "- [papers/](papers/) - LaTeX papers for publication" >> docs/README.md
	@echo "- [sessions/](sessions/) - Discovery narratives by date" >> docs/README.md
	@echo "- [failed-attempts/](failed-attempts/) - Dead ends (educational)" >> docs/README.md
	@echo "" >> docs/README.md
	@echo "---" >> docs/README.md
	@echo "*Auto-generated by \`make preview\`*" >> docs/README.md
	@echo "✓ Generated docs/README.md"

preview/%.html: %.md
	@mkdir -p $(dir $@)
	@sed 's/\.md)/\.html)/g' $< | pandoc -f markdown -o $@ --mathjax --standalone --metadata title="$(notdir $(basename $<))"
	@echo "✓ Generated $@"

.PHONY: copy-assets
copy-assets:
	@mkdir -p preview/reports
	@if [ -d reports ] && [ -n "$$(ls -A reports/*.svg 2>/dev/null)" ]; then \
		cp reports/*.svg preview/reports/ 2>/dev/null || true; \
		echo "✓ Copied SVG assets to preview/reports/"; \
	fi

clean:
	rm -rf preview/
	@echo "✓ Cleaned preview files"
